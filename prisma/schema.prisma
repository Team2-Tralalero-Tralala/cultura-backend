// prisma/schema.prisma

generator client {
    provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ===================== Enums ===================== */

enum ImageType {
  COVER
  GALLERY
  VIDEO
  LOGO
}

enum Gender {
  FEMALE
  MALE
  NONE
}

enum CommunityStatus {
  OPEN
  CLOSED
}

enum PackagePublishStatus {
  PUBLISH
  UNPUBLISH
  DRAFT
}

enum PackageApproveStatus {
  PENDING
  APPROVE
  PENDING_SUPER
}

enum BookingStatus {
  PENDING
  REFUND_PENDING
  REFUNDED
  BOOKED
  CANCELLED
}

enum HHStatus {
  AVAILABLE
  BOOKED
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

/* ===================== Models ===================== */

model Banner {
  id        Int         @id @default(autoincrement())   @map("bn_id")
  image     String      @db.VarChar(256)                @map("bn_image") 

  @@map("banners")
}

model StoreImage {
  id        Int         @id @default(autoincrement())   @map("si_id")
  storeId   Int                                         @map("si_store_id")
  image     String      @db.VarChar(256)                @map("si_image") 
  type      ImageType                                   @map("si_type")

  store Store @relation(fields: [storeId],references: [id],onDelete: Cascade)
  @@index([storeId])
  @@map("store_image")
}

model Store {
  id           Int     @id @default(autoincrement()) @map("st_id")
  name         String  @db.VarChar(80)               @map("st_name")
  detail       String  @db.VarChar(200)              @map("st_detail")
  communityId  Int     @map("st_community_id")
  locationId   Int     @map("st_location_id")

  // Relations
  community   Community @relation(fields: [communityId], references: [id],onDelete: Cascade)
  location    Location  @relation(fields: [locationId], references: [id],onDelete: Cascade)
  tagStores   TagStore[]
  storeImgae  StoreImage[]

  @@index([communityId])
  @@index([locationId])
  @@map("stores")
}

model HomestayImage {
  id        Int         @id @default(autoincrement())   @map("hi_id")
  homestayId   Int                                         @map("hi_homestay_id")
  image     String      @db.VarChar(256)                @map("hi_image") 
  type      ImageType                                   @map("hi_type")

  homestay Homestay     @relation(fields: [homestayId],references: [id],onDelete: Cascade)

  @@index([homestayId])
  @@map("homestay_images")
}

model Homestay {
  id           Int      @id @default(autoincrement())   @map("ht_id")
  communityId  Int                                      @map("st_community_id")
  locationId   Int                                      @map("st_location_id")
  name         String   @db.VarChar(60)                 @map("ht_name")
  roomType     String   @db.VarChar(45)                 @map("ht_room_type")
  capacity     Int                                      @map("ht_capacity")
  detail       String   @db.VarChar(200)                @map("ht_detail")

  // Relations
  community   Community @relation(fields: [communityId], references: [id],onDelete: Cascade)
  location    Location  @relation(fields: [locationId], references: [id],onDelete: Cascade)
  homestayHistories HomestayHistory[]
  tagHomestays      TagHomestay[]
  homestayImage      HomestayImage[]

  @@index([communityId])
  @@index([locationId])

  @@map("homestays")
}

model CommunityImage {
  id            Int         @id @default(autoincrement())   @map("ci_id")
  communityId   Int                                         @map("ci_commuinty_id")
  image         String      @db.VarChar(256)                @map("ci_image") 
  type          ImageType                                   @map("ci_type")

  community     Community   @relation(fields: [communityId],references: [id],onDelete: Cascade)

  @@index([communityId])
  @@map("community_images")
}

model Community {
  id                        Int                 @id @default(autoincrement()) @map("ct_id")
  locationId                Int                 @map("ct_location_id")
  adminId                   Int                 @unique @map("ct_admin_id")
  bankAccountId             Int                 @unique @map("ct_bank_account_id")
  name                      String              @unique @db.VarChar(150)  @map("ct_name")
  alias                     String?             @db.VarChar(100)          @map("ct_alias")
  type                      String              @db.VarChar(90)           @map("ct_type")
  registerNumber            String              @unique @db.VarChar(45)   @map("ct_register_number")
  registerDate              DateTime            @db.Date                  @map("ct_register_date")
  description               String              @db.VarChar(200)          @map("ct_description")
  mainActivityName          String              @db.VarChar(80)           @map("ct_main_activity_name")
  mainActivityDescription   String              @db.VarChar(150)          @map("ct_main_activity_description")
  status                    CommunityStatus?    @default(CLOSED)   @map("ct_status")
  phone                     String              @unique @db.VarChar(10)   @map("ct_phone")
  rating                    Float               @db.Double                @map("ct_rating")
  email                     String              @unique @db.VarChar(65)   @map("ct_email")
  bank                      String              @db.VarChar(100)          @map("ct_bank")
  bankAccountName           String              @db.VarChar(70)           @map("ct_bank_account_name")
  bankAccountNumber         String              @db.VarChar(20)           @map("ct_bank_account_number")
  mainAdmin                 String              @db.VarChar(100)           @map("ct_main_admin")
  mainAdminPhone            String              @db.VarChar(10)            @map("ct_main_admin_phone")
  coordinatorName           String?             @db.VarChar(150)          @map("ct_coordinator_name")
  coordinatorPhone          String?             @db.VarChar(10)           @map("ct_coordinator_phone")
  urlWebsite                String?             @db.VarChar(2048)         @map("ct_url_website")
  urlFacebook               String?             @db.VarChar(2048)         @map("ct_url_facebook")
  urlLine                   String?             @db.VarChar(2048)         @map("ct_url_line")
  urlTiktok                 String?             @db.VarChar(2048)         @map("ct_url_tiktok")
  urlOther                  String?             @db.VarChar(2048)         @map("ct_url_other")

  // Relations
  location        Location          @relation(fields: [locationId], references: [id])
  admin           User              @relation("CommunityAdmin", fields: [adminId], references: [id])
  bankAccount     BankAccount       @relation(fields: [bankAccountId], references: [id])
  member          User[]            @relation("CommunityMember")
  packages        Package[]
  stores          Store[]
  homestays       Homestay[]
  communityImage  CommunityImage[]

  @@index([locationId])
  @@index([adminId])
  @@index([bankAccountId])
  @@map("communities")
}

model BankAccount {
  id                Int     @id @default(autoincrement())   @map("ba_id")
  bankName          String  @db.VarChar(45)                 @map("ba_bank_name")
  accountName       String  @db.VarChar(45)                 @map("ba_account_name")
  accountNumber     String  @db.VarChar(45)                 @map("ba_account_number")

  community Community[]
  bookingHistory BookingHistory[]
  @@map("bank_accounts")
}

model PackageFile {
  id            Int         @id @default(autoincrement())   @map("pf_id")
  packageId     Int                                         @map("pf_package_id")
  filePath      String      @db.VarChar(256)                @map("pf_image") 
  type          ImageType                          @map("pf_type")

  package Package @relation(fields: [packageId],references: [id],onDelete: Cascade)

  @@index([packageId])
  @@map("package_files")
}

model Package {
  id               Int                     @id @default(autoincrement()) @map("pk_id")
  communityId      Int                     @map("pk_community_id")
  locationId       Int                     @map("pk_location_id")
  overseerMemberId Int                     @map("pk_overseer_member_id")
  createById       Int                     @map("pk_create_by")
  name             String                  @db.VarChar(100)              @map("pk_name")
  description      String                  @db.VarChar(500)              @map("pk_description")
  capacity         Int                                                   @map("pk_capacity")
  price            Float                   @db.Double                    @map("pk_price")
  warning          String                  @db.VarChar(200)              @map("pk_warning")
  statusPackage    PackagePublishStatus                                  @map("pk_status_package")
  statusApprove    PackageApproveStatus?                                 @map("pk_status_approve")
  startDate        DateTime                @db.DateTime                  @map("pk_start_date")
  dueDate          DateTime                @db.DateTime                  @map("pk_due_date")
  facility         String                  @db.VarChar(200)              @map("pk_facility")
  rejectReason     String?                 @db.VarChar(100)              @map("pk_reject_reason")

  // Relations
  community        Community       @relation(fields: [communityId], references: [id],onDelete: Cascade)
  location         Location        @relation(fields: [locationId], references: [id],onDelete: Cascade)
  createPackage    User            @relation("createPackage",fields: [createById], references: [id],onDelete: Cascade)
  overseerPackage  User            @relation("OverseerMember", fields: [overseerMemberId], references: [id])

  bookingHistories  BookingHistory[]
  homestayHistories HomestayHistory[]
  tagPackages       TagsPackages[]
  packageFile       PackageFile[]

  @@index([communityId])
  @@index([locationId])
  @@index([createById])
  @@index([overseerMemberId])
  @@map("packages")
}

model Role {
  id              Int               @id @default(autoincrement()) @map("re_id")
  name            String            @unique @db.VarChar(45) @map("re_name")

  // Relations
  users               User[]
  @@map("roles")
}

model User {
  id            Int           @id @default(autoincrement())       @map("us_id")
  roleId        Int           @map("us_role_id")
  memberOfCommunity Int?      @map("us_member_of_community")
  profileImage  String?       @db.VarChar(256)                    @map("us_profile_image")
  username      String        @unique @db.VarChar(50)             @map("us_username")
  email         String        @unique @db.VarChar(65)             @map("us_email")
  password      String        @db.VarChar(255)                    @map("us_password")
  fname         String        @db.VarChar(100)                    @map("us_fname")
  lname         String        @db.VarChar(100)                    @map("us_lname")
  phone         String        @unique @db.VarChar(10)             @map("us_phone")
  gender        Gender?                                           @map("us_gender")
  birthDate     DateTime?     @db.Date                            @map("us_birth_date")
  subDistrict   String?       @db.VarChar(60)                     @map("us_sub_district")
  district      String?       @db.VarChar(60)                     @map("us_district")
  province      String?       @db.VarChar(60)                     @map("us_province")
  postalCode    String?       @db.VarChar(5)                      @map("us_postal_code")
  activityRole  String?       @db.VarChar(100)                    @map("us_activity_role")
  status        UserStatus?   @default(ACTIVE)                    @map("us_status")

  // Relations
  role             Role              @relation(fields: [roleId], references: [id])
  memberOf         Community?        @relation("CommunityMember", fields: [memberOfCommunity], references: [id])
  communitiesAdmin Community[]       @relation("CommunityAdmin")
  bookingHistories BookingHistory[]  @relation("Tourist")
  feedbacksReplied Feedback[]        @relation("FeedbackResponder")
  logs             Log[]
  overseerPackages Package[]          @relation("OverseerMember")
  createdPackages   Package[]          @relation("createPackage")


  @@index([roleId])
  @@map("users")
}

model FeedbackImage {
  id         Int      @id @default(autoincrement()) @map("fi_id")
  feedbackId Int      @unique                            @map("fi_feedback_id")
  image      String   @db.VarChar(256)              @map("fi_image")

  // Relations
  feedback Feedback @relation(fields: [feedbackId], references: [id],onDelete: Cascade)

  @@index([feedbackId])
  @@map("feedback_images")
}

model Location {
  id            Int       @id @default(autoincrement()) @map("lt_id")
  detail        String?   @db.VarChar(100)              @map("lt_detail")
  houseNumber   String  @db.VarChar(10)               @map("lt_houseNumber")
  villageNumber Int?                                  @map("lt_village_number")
  alley         String? @db.VarChar(60)               @map("lt_alley")
  subDistrict   String  @db.VarChar(60)               @map("lt_sub_district")
  district      String  @db.VarChar(60)               @map("lt_district")
  province      String  @db.VarChar(60)               @map("lt_province")
  postalCode    String  @db.VarChar(5)                @map("lt_postal_code")
  latitude      Float   @db.Double                    @map("lt_latitude")
  longitude     Float   @db.Double                    @map("lt_longitude")

  // Relations
  communities Community[]
  packages    Package[]
  stores      Store[]
  homestays   Homestay[]

  @@map("locations")
}

model BookingHistory {
  id               Int        @id @default(autoincrement()) @map("bh_id") 
  touristId        Int        @map("bh_tourist_id")
  packageId        Int?       @map("bh_package_id")
  touristBankId    Int?       @map("bh_tourist_bank_account_id")
  bookingAt        DateTime   @db.Timestamp(0)  @map("bh_booking_at")
  cancelAt         DateTime?  @db.Timestamp(0)  @map("bh_cancel_at")
  refundAt         DateTime?  @db.Timestamp(0)  @map("bh_refund_at")
  status           BookingStatus?               @map("bh_status")
  totalParticipant Int                            @map("bh_total_participant")
  rejectReason     String?    @db.VarChar(100)  @map("bh_reject_reason")
  transferSlip     String?    @db.VarChar(256)  @map("bh_transfer_slip")

  // Relations
  tourist  User         @relation("Tourist", fields: [touristId], references: [id])
  package  Package?     @relation(fields: [packageId], references: [id],onDelete: SetNull)
  bank      BankAccount? @relation(fields: [touristBankId], references: [id])
  feedbacks Feedback[]

  @@index([packageId])
  @@index([touristId])
  @@map("booking_histories")
}

model Feedback {
  id                Int       @id @default(autoincrement()) @map("fb_id")
  bookingHistoryId  Int       @map("fb_booking_history_id")
  createdAt         DateTime  @db.Timestamp(0)              @map("fb_created_at")
  message           String    @db.VarChar(200)              @map("fb_message")
  rating            Float     @db.Double                    @map("fb_rating")
  responderId       Int?                                     @map("fb_responder_id")
  replyAt         DateTime? @db.Timestamp(0)              @map("fb_reply_at")
  replyMessage      String?   @db.VarChar(100)              @map("fb_reply_message")

  // Relations
  bookingHistory BookingHistory @relation(fields: [bookingHistoryId], references: [id])
  responder      User?          @relation("FeedbackResponder", fields: [responderId], references: [id])
  feedbackImages FeedbackImage[]

  @@index([bookingHistoryId])
  @@index([responderId])
  @@map("feedbacks")
}

model Tag {
  id      Int    @id @default(autoincrement()) @map("tg_id")
  name    String @unique @db.VarChar(90) @map("tg_name")

  // Relations
  tagHomestays  TagHomestay[]
  tagPackages   TagsPackages[]
  tagStores     TagStore[]

  @@map("tags")
}

model HomestayHistory {
  id            Int        @id @default(autoincrement()) @map("hh_id")
  packageId     Int        @map("hh_package_id")
  homestayId    Int        @map("hh_homestay_id")
  guestAmount   Int        @map("hh_guest_amount")
  checkInTime   DateTime   @db.DateTime                 @map("hh_check_in_time")
  checkOutTime  DateTime   @db.DateTime                 @map("hh_check_out_time")

  // Relations
  package   Package  @relation(fields: [packageId], references: [id])
  homestay  Homestay @relation(fields: [homestayId], references: [id])

  @@index([homestayId])
  @@index([packageId])
  @@map("homestay_histories")
}

model Log {
  id          Int       @id @default(autoincrement()) @map("lg_id")
  userId      Int       @map("lg_user_id")
  loginTime   DateTime? @db.Timestamp(0)              @map("lg_login_at")
  logoutTime  DateTime? @db.Timestamp(0)              @map("lg_logout_at")
  ipAddress   String    @db.VarChar(45)              @map("lg_ip_address")

  // Relations
  user  User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("logs")
}

/* ====== Explicit join tables (ตามสคีมาเดิม) ====== */

model TagHomestay {
  tagId      Int @map("tght_tag_id")
  homestayId Int @map("tght_homestay_id")

  // Relations
  tag      Tag      @relation(fields: [tagId], references: [id])
  homestay Homestay @relation(fields: [homestayId], references: [id],onDelete: Cascade)

  @@id([tagId, homestayId])
  @@index([homestayId])
  @@index([tagId])
  @@map("tag_homestays")
}

model TagsPackages {
  tagId     Int @map("tgpk_tag_id")
  packageId Int @map("tgpk_package_id")

  // Relations
  tag     Tag     @relation(fields: [tagId], references: [id])
  package Package @relation(fields: [packageId], references: [id],onDelete: Cascade)

  @@id([tagId, packageId])
  @@index([packageId])
  @@index([tagId])
  @@map("tags_packages")
}

model TagStore {
  tagId   Int @map("tgst_tag_id")
  storeId Int @map("tgst_store_id")

  // Relations
  tag   Tag   @relation(fields: [tagId], references: [id])
  store Store @relation(fields: [storeId], references: [id],onDelete: Cascade)

  @@id([tagId, storeId])
  @@index([storeId])
  @@index([tagId])
  @@map("tag_stores")
}
